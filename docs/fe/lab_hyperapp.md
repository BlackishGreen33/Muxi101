# Lab: 使用 Hyperapp 编写 TodoList


## GUI 编程：一个由组件构成的世界


前端方向所编写的主要是运行在 Web 浏览器中的 GUI（图形化用户界面）应用程序。包括简单的新闻页面，到复杂的在线 [Office 等应用](https://shimo.im/)，都可以在浏览器内实现。

> 这是比较狭义的前端。目前广义的大前端工程师也会做一些服务端和客户端的研发。但对前端来说，编写用户界面始终是核心的话题。

之前大家也写过页面。页面是由很多个相互嵌套的标签构成的。如果我们把页面内容按页面的结构分组，就可以分出很多的组件（Component）。

写组件，主要是通过 JavaScript 实现的。原因如下：

+ 像之前写页面那样，直接写 HTML 和 CSS，就无法实现组件化的，因为组件化的前提是模块化。**只有 JS 有模块化的能力**。
+ 组件除了结构（HTML）和样式（CSS）之外，最主要的是**交互逻辑**，也就是这个组件会响应用户的操作，对页面进行动态的修改。以及和服务端交互，发送网络请求获取数据，展示在页面中等等。这部分逻辑是通过浏览器的 API 实现的，主要是 DOM 相关。比如我们可以使用 DOM API 去动态的增加元素，修改元素。我们可以用 `addEventListener` 来添加事件，响应用户交互。用 fetch API 发送网络请求。这些交互逻辑显然只能在 JS 中实现。

所以对于前端中的组件化，一个组件就是一个 JS 模块，这个模块控制了页面某块区域的**结构，样式，和用户交互逻辑**。

> 如果对组件化还有疑问，可以看[这篇专题](/101/fe/component.html)。里面用一个页面作为例子，讲了具体的组件拆分方式。

GUI 编程其实就是一个搭积木的过程，拆分组件，若干个组件拼成一个页面，所有的页面加起来，就构成了一个应用程序（Application）。

看到这里，你可能对如何使用 JS 写一个应用，如何写一个组件，还是没有概念。接下来我们就会借助一个第三方库：Hyperapp，来实现 GUI 编程。



## Hyperapp 简介：`UI = f(state)`

一般学一种新的技术，我们都会看一个 Hello World 例子。

[Hyperapp](https://github.com/jorgebucaran/hyperapp) 的 Github 主页上就有一个例子：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <script type="module">
      import { h, text, app } from "https://unpkg.com/hyperapp"

      const AddTodo = (state) => ({
        ...state,
        todos: state.todos.concat(state.value),
      })

      const NewValue = (state, event) => ({
        ...state,
        value: event.target.value,
      })

      app({
        init: { todos: [], value: "" },
        view: ({ todos, value }) =>
          h("main", {}, [
            h("input", { type: "text", oninput: NewValue, value }),
            h("button", { onclick: AddTodo }, text("Add")),
            h("ul", {},
              todos.map((todo) => h("li", {}, text(todo)))
            ),
          ]),
        node: document.getElementById("app"),
      })
    </script>
  </head>
  <body>
    <main id="app"></main>
  </body>
</html>
```

因为只是一个简单的例子，所以不会使用之前的 Lab 那样用 Webpack 做构建。大家可以在本地新建一个 HTML 复制以上内容，就可以运行例子了。如果是在线 Demo 的话，我们常用 [CodeSandbox](https://codesandbox.io/)。

这个例子实现的就是一个简单的 TodoList，用户可以添加 todo，添加之后的 todo 会展示在列表中。但它没有删除 todo，编辑 todo，标记 todo 为完成，筛选等等功能，这也是后面我们需要完善的。

在完善 Todo 之前，我们首先要学习 Hyperapp 这项技术。这是一个第三方 JS 库，可以简单的理解为是某一个开发者编写的一些 JS 包，这些包的可以帮助我们搭建组件化的的 Web 应用。在 GitHub 仓库里，我们可以看到 [index.js](https://github.com/jorgebucaran/hyperapp/blob/main/index.js)，这就是 Hyperapp 的源代码。一共 400 多行。讲这些是想告诉大家，我们 npm install 的那些包，也是用 JS 写的普通代码，并没有什么神奇的。我们以后也可以自己写一个库，发布成 npm 包。

在学技术的时候，尤其是对于初学者，要注意**不求甚解**，也就是不要钻牛角尖，先有一个大概理解即可。因为一项技术往往会有自己的设计理念，会引入一些新的概念。我们首先要全盘接受，慢慢的理解，等到后期接触过很多相关技术了，就会有自己的认识和评判。

> 以上的主要是针对值得学的技术，哪些技术值得学，哪些不值得，这也是大家要养成的一种鉴别能力。

我们先笼统的看一下以上的例子。这段 JS 里最核心的是 app 的函数调用，调用时传入了一个对象作为参数。app 就指的是 application，就是一个 Web 应用。一般一个应用都会有一个初始化的地方，负责启动整个应用，在 Hyperapp 里，调用 app 函数就负责这点。

app 的参数有三个，init，view 和 node。node 很好理解，就是这个 app 会渲染在哪个 DOM 节点里。在组件化的前端开发中，DOM 结构一般都是动态创建的，一般只需要给一个节点作为插入元素的父节点即可。

view 是一个函数。view 返回的就是 app 的视图结构，其实就是 DOM 结构。里面用到了名为 h 的函数。我们可以简单的把 h 函数的作用理解为 document.createElement，是用来创建 DOM 元素的。这里不直接用 DOM API，而是用 hyperapp 提供的函数，是因为 hyperapp 会帮助处理真正的 DOM 操作，你只需要提供给它一个 DOM 结构的描述即可。

这个函数第一个参数是所创建的 DOM 节点的标签名，第二个参数是传给 DOM 节点的属性，第三个参数是节点的子元素数组。调用之后返回的是一个对象：

// todo console 图

这种模式一般叫做虚拟 DOM 或者虚拟节点。就是说我们在写视图层代码时，只创建出 DOM 元素结构的描述，再由框架去帮我们真正创建节点。这样的好处在后面会讲到。目前大家只需要习惯用这种方式去描述 DOM 结构即可。

> 用对象 + 属性的方式，去描述一个实体，这就是一种抽象。DOM 元素的主要特点是，有一个标签名，有一些属性，可能有一组子元素。这就对应了 h 函数的三个参数。是对实际 DOM 元素的一种抽象。这种技巧在编程中非常常见。软件开发本身，很大程度上是对现实世界的抽象。而在计算机系统的分层架构中，也存在着很多的抽象。抽象让我们抛开事物的繁杂，只抓住其中的重点。这样可以显著的降低用户或者软件开发者所面对的复杂度。

小练习：使用 Hyperapp 创建 DOM 结构

// todo 小练习


Hyperapp 里面主要有这些 API 和概念：

#### 视图（view）和状态（state）

#### API：`app` 和 `h`



## 告别 h，使用 JSX


## TodoList





## 拓展：React 与 Hyperapp



## 拓展：No Magic!! Hyperapp 源码解析


你需要记得一件事，**No Magic**。这是一个很朴素的理念，你必须搞懂你所使用的工具（在这个场景下，是第三方库），并且有自己实现这个工具的能力，你才可以真正驾驭这个工具。

第三方 JS 库，其实也是用 JS 写的，和你自己写的 JS 代码并不存在什么区别。这个库也不是一个黑盒子。只要你懂 JS，它对你来说就应该是透明的。当然理解这个库的原理会需要你理解一些 Web GUI 编程的设计理念，花费一些时间专研，但绝对不是一件难事。

我们在教大家使用 React 进行前端开发之前，首先引入 Hyperapp，就是因为这个库足够简单，但又包含了编写一个组件化 Web APP 所需要的的必要元素。用过 Hyperapp 之后，你可以看懂它的源代码，从而理解这种 UI 组件基础库的本质。这对于未来的前端开发之路有很大的帮助，因为你知道，这些东西都是普通的，没有魔法。


> 按 No Magic 的理念，我们是否需要知道浏览器的原理呢？其实这个理念是相对而言的。计算机系统由许多不同软硬件技术共同构成，这些技术是分层的。比如操作系统层面，编程语言层面，
对 JS 这项基础技术来说，如果你掌握了 JS 本身，那用 JS 写出来的东西，都不应该是什么秘密（这些都属于 JS 相关的范畴）。探究 JS 本身是怎么实现的，其实已经进入了另一个领域（编程语言实现）了，所以就算你不了解 JS 是怎么被编译运行的，你也能写出好的 Web App。但如果你对浏览器和 JS 引擎的原理有了解，肯定会对你有很大的帮助。总的来说，作为一个前端开发，你不需要看懂浏览器和 JS 引擎的 C++ 源码，但你至少需要了解浏览器和 JS 引擎的一些关键原理。相比用 Hyperapp 写东西 + 读懂 Hyperapp 源码这种组合，这个要求要低很多。计算机的世界有一个很重要的理念，就是分层。不同层之间通过某种协议和接口进行联系。我们要有分辨一项技术属于哪一层的能力。对于同一层里面的技术，你应该有看懂源码的能力。

>![layered](./img/component/layerer.jpg)
> *计算机系统的分层架构*